name: Deploy

on:
  workflow_dispatch:
       
jobs: 
  deploy:
    runs-on: ubuntu-latest
    environment: Dev
    steps:
    - uses: actions/github-script@v4
      with:
        script: |          
          const approvals = await github.request('GET /repos/{owner}/{repo}/actions/runs/{run_id}/approvals', {
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId
          })

          if (approvals.data.length == 0){
            core.setFailed(`There are no approvals for this deployment. This is not allowed.`);          
            return; 
          }

          const latestApproval = approvals.data[0];
          console.log(approvals);
          if (latestApproval.user.login == context.actor){
            core.setFailed(`Deployment to the environment is approved by the same person (${context.actor}) who initiated the deployment. This is not allowed.`);            
            return;
          }
    - run: |
        echo "Deploying..."